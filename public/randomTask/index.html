<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap">
  <!-- Typicons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/typicons/2.0.9/typicons.css"/>
  <!-- Flavicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
  <title>Random Task</title>
</head>

<body>
<style>
  *{
    font-family: 'Nunito', sans-serif;
    color: darkslategrey;
    box-sizing: border-box;
  }
  #logInScreen{
    display: flex;
    background-color: white;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 2000;
  }
  #logInDiv{
    width: 50%;
    padding: 15px;
    margin: auto;
    border-style: solid;
    border-width: 2px 3px 3px 2px;
    border-radius: 5px;
    z-index: 2200;
    text-align: center;
  }
  #cloudIt{
    float: right;
    margin-top: 15px;
    font-size: 25px;
    line-height: 1em;
    padding: 2px 0 2px 5px;
  }
  #listSection{
    position: relative;
  }
  #clickScreen{
    position: absolute;
    width: 100vw;
    height: 100vh;
    top: 0;
    left: 0;
    z-index: 500;
    background-color: rgba(255, 255, 255, 0);
  }
  button {
    border-top: 2px solid darkslategrey;
    border-left: 2px solid darkslategrey;
    border-right: 4px solid darkslategrey;
    border-bottom: 4px solid darkslategrey;
    border-radius: 5px;
    padding: 5px 10px;
    width: fit-content;
    color: darkslategrey;
    text-align: center;
    font-size: 1em;
    font-weight: 600;
    background-color: lightgrey;
  }
  button span:nth-of-type(1){
    padding-right: 5px;
  }
  button span:nth-of-type(2){
    padding-left: 5px;
  }
  input[type="text"]{
    border-top: 2px solid darkslategrey;
    border-left: 2px solid darkslategrey;
    border-right: 4px solid darkslategrey;
    border-bottom: 4px solid darkslategrey;
    border-radius: 5px;
    padding: 5px 10px;
    width: fit-content;
    color: darkslategrey;
    font-size: 1em;
    font-weight: 600;
  }
  input[type="radio"]{
    display: none;
  }
  .topList{
    margin-bottom: 0;
  }
  .sousBtn{
    margin-top: 0;
  }
  #listSection{
    text-align: left;
  }
  #toDoSection{
    display: flex;
    flex-flow: column nowrap;
    text-align: center;
  }
  #toDoSection button{
    width: fit-content;
    margin: 10px auto;
  }
  #taskToDo{
    color: darkmagenta;
    font-size: 1.5em;
    font-weight: 700;
  }
  ul{
    list-style: none;
    padding: 0;
  }
  #list{
    margin-top: 0;
    width: 100%;
  }
  #list li{
    width: 100%;
    position: relative;
    font-weight: 600;
    display: flex;
    flex-flow: row nowrap;
    justify-content: space-between;
    align-items: baseline;
  }
  li span{
    padding-right: 3px;
    font-size: 1.3em;
  }
  li .text{
    flex-grow: 1;
  }
  .colorSpan{
    padding-left: 10px;
  }
  .emptyCheck{
    font-size: 2em;
    translate: 0 3.5px;
    line-height: 1em;
  }
  .trashCan, .recycle{
    padding-left: 10px;
    font-size: 1.5em;
  }
  
  #colorPalet{
    background-color: white;
    border: 2px solid darkslategrey;
    border-radius: 5px;
    position: absolute;
    z-index: 1000;
    top: 2px;
    right: 2.5px;
  }
  .colorTd{
    width: fit-content;
    height: 25px;
    border: none;
  }
  input[name="colorRadio"] + label > div{
    width: 70px;
    height: 25px;
    display: flex;
    justify-items: center;
    align-items: center;
    border-radius: 2.5px;
  }
  input[name="colorRadio"]:checked + label > div{
    background-color: rgba(47, 79, 79, .3);
 
  }
  .colorDiv{
    width: 65px;
    height: 20px;
    border-radius: 25px;
    border: none;
    margin: auto;
    line-height: 14px;
    text-align: center;
    font-size: 14px;
    padding: 3px 7px 4px;
  }
  .orange{
    background-color: orange;
  }
  .red{
    background-color: red;
  }
  .darkmagenta{
    background-color: darkmagenta;
    color: white;
  }
  .dodgerblue {
    background-color: dodgerblue;
  }
  .forestgreen{
    background-color: forestgreen;
    color: white;
  }
  .darkslategrey{
    background-color: darkslategrey;
    color: white;
  }
  
  hr{
    margin: 30px 0 0;
  }
  #doneZone{
    margin-top: 8px;
  }
  #doneZone li{
    display: flex;
    flex-flow: row nowrap;
    justify-content: space-between;
    align-items: baseline;
  }
  #doneZone li span.text{
    font-size: 18px;
    text-decoration: line-through;
  }
  #doneZone p{
    margin-bottom: 0;
    text-decoration: underline;
  }
  .displayNone{
    display: none!important;
  }
</style>
  <div id="listSection">
    <div id="clickScreen" class="displayNone"></div>
    <div id="logInScreen">
      <div id="logInDiv">
        <h3>First thing's first...</h3>
        <h2 >Who do you think you are?!</h2>
        <button id="logInBtn">Log in</button>
      </div>
    </div>
    <form id="addForm">
      <input id="addInput" type="text" />
      <button id="addBtn" type="submit">add</button>
    </form>
    <h5 class="topList">The never ending list...</h5>
    <ul id="list"></ul>
    <table id="colorPalet" class="displayNone">
      <tr class="colorTr">
        <td class="colorTd">
          <input type="radio" id="orangeRadio" name="colorRadio" value="orange" />
          <label for="orangeRadio">
            <div>
              <div class="colorDiv orange">people</div>
            </div>
          </label>
        </td>
        <td class="colorTd">
          <input type="radio" id="redRadio" name="colorRadio" value="red" />
          <label for="redRadio">
            <div>
              <div class="colorDiv red">urgent</div>
            </div>
          </label>
        </td>
      </tr>
      <tr class="colorTr">
        <td class="colorTd">
          <input type="radio" id="darkmagentaRadio" name="colorRadio" value="darkmagenta" />
          <label for="darkmagentaRadio">
            <div>
              <div class="colorDiv darkmagenta">errand</div>
            </div>
          </label>
        </td>
        <td class="colorTd">
          <input type="radio" id="dodgerblueRadio" name="colorRadio" value="dodgerblue" />
          <label for="dodgerblueRadio">
            <div>
              <div class="colorDiv dodgerblue">screen</div>
            </div>
          </label>
        </td>
      </tr>
      <tr class="colorTr">
        <td class="colorTd">
          <input type="radio" id="forestgreenRadio" name="colorRadio" value="forestgreen" />
          <label for="forestgreenRadio">
            <div>
                <div class="colorDiv forestgreen">physic</div>
            </div>
          </label>
        </td>
        <td class="colorTd">
          <input type="radio" id="darkslategreyRadio" name="colorRadio" value="darkslategrey" checked/>
          <label for="darkslategreyRadio">
            <div>
              <div class="colorDiv darkslategrey">else</div>
            </div>
          </label>
        </td>
      </tr>
    </table>
    <button id="shuffleBtn">Shuffle it!</button>
    <h5 class="sousBtn">Tell me what to do!</h5>
    <hr />
    <h3 style="display: inline-block;">Done Zone</h3>
    <button id="cloudIt"><span class="typcn typcn-cloud-storage-outline"></span></button>
    <ul id="doneZone"></ul>
  </div>
  <div id="toDoSection" class="displayNone">
    <h3>Fac l√†,<br />pour les 30 prochaines minutes,<br />tu vas...</h3>
    <p id="taskToDo"></p>
    <button id="nopeNextBtn"><span class="typcn typcn-arrow-sync"></span>Nope, next!<span class="typcn typcn-arrow-sync"></span></button>
    <button id="doneNextBtn"><span class="typcn typcn-thumbs-up"></span>Done, next!!<span class="typcn typcn-arrow-right-outline"></span></button>
    <button id="backBtn"><span class="typcn typcn-arrow-left-outline"></span>Back!</button>
  </div>
  <!-- errands, housework, computer, cellphone, people -->
  <!-- <table id="colorPalet" class="displayNone">
    <tr class="colorTr">
      <td class="colorTd">
        <input type="radio" id="orangeRadio" name="colorRadio" value="orange" />
        <label for="orangeRadio">
          <div>
            <div class="colorDiv orange"></div>
          </div>
        </label>
      </td>
      <td class="colorTd">
        <input type="radio" id="redRadio" name="colorRadio" value="red" />
        <label for="redRadio">
          <div>
            <div class="colorDiv red"></div>
          </div>
        </label>
      </td>
      <td class="colorTd">
        <input type="radio" id="darkmagentaRadio" name="colorRadio" value="darkmagenta" />
        <label for="darkmagentaRadio">
          <div>
            <div class="colorDiv darkmagenta"></div>
          </div>
        </label>
      </td>
    </tr>
    <tr class="colorTr">
      <td class="colorTd">
        <input type="radio" id="dodgerblueRadio" name="colorRadio" value="dodgerblue" />
        <label for="dodgerblueRadio">
          <div>
            <div class="colorDiv dodgerblue"></div>
          </div>
        </label>
      </td>
      <td class="colorTd">
        <input type="radio" id="forestgreenRadio" name="colorRadio" value="forestgreen" />
        <label for="forestgreenRadio">
          <div>
              <div class="colorDiv forestgreen"></div>
          </div>
        </label>
      </td>
      <td class="colorTd">
        <input type="radio" id="darkslategreyRadio" name="colorRadio" value="darkslategrey" checked/>
        <label for="darkslategreyRadio">
          <div>
            <div class="colorDiv darkslategrey"></div>
          </div>
        </label>
      </td>
    </tr>
  </table>-->
<script type="module">
  import { getFirestore, collection, getDocs, getDoc, query, where, addDoc, deleteDoc, doc, setDoc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";
  import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js";
  import { app, analytics, db, auth, provider } from "../myFirebase.js";
  auth.languageCode = 'fr';

  getRedirectResult(auth)
    .then((result) => {
      // This gives you a Google Access Token. You can use it to access Google APIs.
      const credential = GoogleAuthProvider.credentialFromResult(result);
      //console.log("alloooo");
      const token = credential.accessToken;
      // The signed-in user info.
      const user = result.user;
      // IdP data available using getAdditionalUserInfo(result)
      // ...
  }).catch((error) => {
      // Handle Errors here.
      const errorCode = error.code;
      const errorMessage = error.message;
      // The email of the user's account used.
      // const email = error.customData.email;
      // The AuthCredential type that was used.
      const credential = GoogleAuthProvider.credentialFromError(error);
      // ...
  });
  // console.log(auth);

  function logIn(){
    signInWithRedirect(auth, provider);
  };

  onAuthStateChanged(auth,(user) => {
    if(user){
      console.log(user);
      logInScreen.classList.add("displayNone");
      getTasks();
      getDones();
    } else{
      logInScreen.classList.remove("displayNone");
      logInBtn.addEventListener("click", logIn);
    };
  });

  let listTasks = [];
  let listDones = [];
  let myListTasks = [];
  let myListDones = [];
  let num = 0;
  
// *** START

  async function getTasks() {
    // const getTasks = await getDocs(collection(db, "randomTask", auth.currentUser.email, "myListTasks"));
    // getTasks.forEach(doc => {
    //   const constTask = doc.task;
    //   const constColor = doc.color;
    //   myListTasks.push({task:constTask, color:constColor});
    //   console.log(myListTasks);
    // });
    if(localStorage.getItem("listTasks")){
      console.log("storage!");
      listTasks = JSON.parse(localStorage.listTasks);
    } else{
      const getTasks = await getDocs(collection(db, "randomTask", auth.currentUser.email, "myListTasks"));
      getTasks.forEach(doc => {
        const constTask = doc.task;
        const constColor = doc.color;
        myListTasks.push({task:constTask, color:constColor});
        console.log(myListTasks);
      });
      listTasks = myListTasks;
    };
    let idx = 0;
    listTasks.forEach(todo => {
      todoCreation(todo, idx);
      idx++;
    });
  };
  async function getDones() {
    // const getDones = await getDocs(collection(db, "randomTask", auth.currentUser.email, "myListDones"));
    // getDones.forEach(doc => {
    //   const constTask = doc.task;
    //   const constColor = doc.color;
    //   const constDate = doc.date;
    //   myListDones.push({task:constTask, color:constColor, date:constDate});
    //   console.log(myListDones);
    // });
    if(localStorage.getItem("listDones")){
      console.log("storageDones!");
      listDones = JSON.parse(localStorage.listDones);
    } else{
      const getDones = await getDocs(collection(db, "randomTask", auth.currentUser.email, "myListDones"));
      getDones.forEach(doc => {
        const constTask = doc.task;
        const constColor = doc.color;
        const constDate = doc.date;
        myListDones.push({task:constTask, color:constColor, date:constDate});
        console.log(myListDones);
      });
      listDones = myListDones;
    };
    let donedDates = [];
    listDones.forEach(doned => {
      if(!donedDates.includes(doned.date)){
        donedDates.push(doned.date);
      };
    });
    donedDates.forEach(donedDate => {
      donedDateCreation(donedDate);
    });
    let idx = 0;
    listDones.forEach(doned => {
      donedCreation(doned, idx);
      idx++;
    });
  };
//Create a function for these next two that we'll put in the one up there for "if there is a user"
  
  //listLi = listDones.map(doned => {
      //return `<li>${doned.date}<span class="typcn typcn-tick"></span>${doned.task}<span class="typcn typcn-trash trashCan"></span></li>`
    //});
    //doneZone.innerHTML = listLi.join("");
  
// *** CLOUDSAVE
  cloudIt.addEventListener("click", async () => {

  });

// *** CREATION
  function todoCreation(todo, idx){
    let li = document.createElement("li");
    li.innerHTML = `<span class="typcn typcn-media-stop-outline emptyCheck" onclick="checkEvent(this)"></span><span class="text">${todo.task}</span><span class="typcn typcn-tag colorSpan" onclick="colorChoice(this)"></span>`;
    li.setAttribute("id", "todo" + idx);
    li.querySelector(".text").style.color = todo.color;
    list.appendChild(li);
  };

  function donedCreation(doned, idx){
    let donedLi = document.createElement("li");
    donedLi.innerHTML = `<span class="typcn typcn-tick"></span><span class="text">${doned.task}</span><span class="typcn typcn-trash trashCan" onclick="trashCanEvent(this)"></span><span class="typcn typcn-arrow-sync recycle" onclick="recycleEvent(this)"></span>`;
    donedLi.setAttribute("id", "doned" + idx);
    donedLi.querySelector(".text").style.color = doned.color;
    document.getElementById(doned.date).appendChild(donedLi);
  };

  function donedDateCreation(donedDate){
    if(!document.getElementById(donedDate)){
      let donedUlP = document.createElement("p");
      donedUlP.setAttribute("id", donedDate + "p");
      donedUlP.innerText = donedDate;
      doneZone.appendChild(donedUlP);
      let donedUl = document.createElement("ul");
      donedUl.setAttribute("id", donedDate);
      donedUlP.insertAdjacentElement("afterend", donedUl);
    };
  };

  function recycleEvent(recycle){
    let li = recycle.parentElement;
    let color = li.querySelector(".text").style.color;
    let task = li.querySelector(".text").textContent;
    let todo = {
      task: task,
      color: color
    };
    let idx = listTasks.length;
    listTasks.push(todo);
    localStorage.listTasks = JSON.stringify(listTasks);
    todoCreation(todo, idx);
  };

// *** ADD
addForm.addEventListener("submit", (e) => {
    e.preventDefault();
    let newTask = addInput.value;
    let color = "darkslategrey";
    if(!newTask == ""){
      let todo = {
        task: newTask,
        color: color
      };
      let idx = listTasks.length;
      listTasks.push(todo);
      localStorage.listTasks = JSON.stringify(listTasks);
      todoCreation(todo, idx);
      addForm.reset();
      console.log(listTasks);
    };
  });

// *** DONE/ERASE
  doneNextBtn.addEventListener("click", () => {
    let doneLi = document.querySelector("#todo" + num);
    console.log(doneLi);
    let color = doneLi.querySelector(".text").style.color;
    doneLi.remove();
    refreshId("list", "todo");
    gotItDone(num, color);
    if(listTasks.length == 0){
      taskToDo.innerText = "aller t'reposer!";
    } else{
      num = num < listTasks.length ? num : 0;
      taskToDo.innerText = listTasks[num].task;
      taskToDo.style.color = listTasks[num].color;
    };
  });

  function checkEvent(emptyCheck){
    console.log("checkEvent");
    console.log(listTasks);
    let li = emptyCheck.parentElement;
    let color = li.querySelector(".text").style.color;
    let task = li.querySelector(".text").textContent;
    let donedId = li.id.slice(4);
    li.remove();
    refreshId("list", "todo");
    gotItDone(donedId, color);
  };
  
  function gotItDone(nb, color){
    console.log("gotItDone");
    console.log(nb);
    let donedTaskSplice = listTasks.splice(nb, 1);
    let donedTask = donedTaskSplice[0].task;
    console.log(donedTask);
    localStorage.listTasks = JSON.stringify(listTasks);
    let donedDate = getTodayDate(); //return
    let doned = {
      task: donedTask,
      color: color,
      date: donedDate
    };
    let idx = listDones.length;
    listDones.push(doned);
    localStorage.listDones = JSON.stringify(listDones);
    donedDateCreation(donedDate);
    donedCreation(doned, idx);
  };

  function trashCanEvent(trashCan){
    console.log("trashCanEvent");
    let trashedLi = trashCan.parentElement;
    //let trashedUlDate = trashedLi.parentElement.id;
    let trashedTask = trashedLi.querySelector(".text").textContent;
    let trashedTaskId = trashedLi.id.slice(5);
    trashedLi.remove();
    refreshId("doneZone", "doned");
    //let trashedTaskId = listDones.findIndex((doned) => doned.task == trashedTask && doned.date == trashedUlDate);
    console.log(trashedTaskId);
    let trashedObject = listDones.splice(trashedTaskId, 1);
    let trashedPDate = trashedObject[0].date;
    console.log(trashedPDate);
    let dateCount = listDones.filter((td) => td.date == trashedPDate).length;
    if(dateCount == 0){
      document.getElementById(trashedPDate + "p").remove();
      document.getElementById(trashedPDate).remove();
    };
    localStorage.listDones = JSON.stringify(listDones);
  };

// *** REFRESH
  function refreshId(list, task){
    let idx = 0;
    document.querySelectorAll("#" + list + " li") .forEach(li => {
      li.setAttribute("id", task + idx);
      idx++;
    });
  };

// *** SHUFFLE
  shuffleBtn.addEventListener("click", () => {
    for (let i = listTasks.length - 1; i > 0; i--) { 
      const j = Math.floor(Math.random() * (i + 1)); 
      [listTasks[i], listTasks[j]] = [listTasks[j], listTasks[i]]; 
    };
    localStorage.listTasks = JSON.stringify(listTasks);
    //console.log(listTasks);
    list.innerHTML = ``;
    let idx = 0;
    listTasks.forEach(todo => {
      todoCreation(todo, idx);
      idx++;
    });
    //list.classList.add("first");
    listSection.classList.toggle("displayNone");
    toDoSection.classList.toggle("displayNone");
    num = 0;
    taskToDo.innerText = listTasks[num].task;
    taskToDo.style.color = listTasks[num].color;
  });

  nopeNextBtn.addEventListener("click", () => {
    if(listTasks.length == 0){
      taskToDo.innerText = "aller t'reposer!";
    } else{
      num = num < (listTasks.length - 1) ? num + 1 : 0;
      taskToDo.innerText = listTasks[num].task;
      taskToDo.style.color = listTasks[num].color;
    };
  });
    
  backBtn.addEventListener("click", () => {
    listSection.classList.toggle("displayNone");
    toDoSection.classList.toggle("displayNone");
  });
  
// *** COLOR
//const colorList = ["orange", "red", "darkmagenta", "dodgerblue", "forestgreen", "darkslategrey"];
let colorTag;
  function colorChoice(thisOne){
    colorTag = thisOne;
    colorTag.insertAdjacentElement("afterend", colorPalet);
    colorPalet.classList.remove("displayNone");
    clickScreen.classList.remove("displayNone");
    document.querySelectorAll("input[name='colorRadio']").forEach(radio => {
      radio.addEventListener("click", () => {
        let color = radio.value;
        let li = colorTag.parentElement;
        let liTask = li.querySelector(".text").textContent;
        li.querySelector(".text").style.color = color;
        console.log(liTask);
        let taskId = li.id.slice(4);
        //taskId = listTasks.findIndex((todo) => todo.task == liTask);
        listTasks[taskId].color = color;
        console.log(listTasks);
        localStorage.listTasks = JSON.stringify(listTasks);
        clickHandlerColor();
      });
    });
    document.querySelector("#clickScreen").addEventListener("click", clickHandlerColor);
  };
  
  function clickHandlerColor(){
    colorPalet.classList.add("displayNone");
    list.insertAdjacentElement("afterend", colorPalet);
    clickScreen.classList.add("displayNone");
    document.querySelector("#clickScreen").removeEventListener("click", clickHandlerColor);
  };

// *** DATE
  function getTodayDate(){
    let date = new Date();
    let currentDay= String(date.getDate()).padStart(2, '0');
    let currentMonth = String(date.getMonth()+1).padStart(2,"0");
    let currentYear = date.getFullYear();
    let currentDate = `${currentDay}-${currentMonth}-${currentYear}`;
    //let currentDate = currentYear + "-" + currentMonth + "-" + currentDay;
    return currentDate;
  };
  
</script>
</body>

</html>